<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>费用收取</title>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css" />
	</head>

	<body>
		<!--页面标题-->
		<header class="mui-bar mui-bar-nav header-title ">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">费用收取</h1>
		</header>
		<!--页面主体-->
		<div class="mui-content" id="content">
			<ul class="mui-table-view user-info">
				<li class="mui-table-view-cell">
					<span>用户编号：</span><span class="yonghu-info-code"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>用户姓名：</span><span class="yonghu-info-name"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>用户地址：</span><span class="yonghu-info-address"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>用户电话：</span><span class="yonghu-info-phone"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>账户余额：</span><span class="yonghu-info-balance"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>账户状态：</span>
					<span class="yonghu-info-state"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>气表编号：</span><span class="yonghu-info-number"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>价格标准：</span><span class="yonghu-info-standard">
					</span>
				</li>
				<button type="button" class="mui-btn-blue last-btn cost-record-btn">费用记录</button>
			</ul>
			<ul class="mui-table-view user-info reading-chaobiao">
				<li class="mui-table-view-cell">
					<span>当前账期：</span>
					<span class="yonghu-chaobiao-year"></span>
					<span>年</span>
					<span class="yonghu-chaobiao-period"></span>
					<span>月账期</span>
				</li>
				<li class="mui-table-view-cell">
					<span>抄表状态：</span>
					<span class="yonghu-chaobiao-ischaobiao"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>上次读数：</span>
					<span class="yonghu-chaobiao-Qids"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>本次读数：</span>
					<span class="yonghu-chaobiao-Zhids"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>抄见气量：</span>
					<span class="yonghu-chaobiao-Zhids"></span>
				</li>
				<button type="button" class="mui-btn-blue last-btn reading-btn">重新录入</button>
			</ul>
			<ul class="mui-table-view user-info cost-info">
				<li class="mui-table-view-cell">
					<span>欠费期数：</span>
					<span class="yonghu-yingshoufei-length"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>欠费气量：</span>
					<span class="yonghu-yingshoufei-bcql"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>欠费金额：</span>
					<span class="yonghu-yingshoufei-totalje"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>　滞纳金：</span>
					<span class="yonghu-yingshoufei-lateFee"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>账户余额：</span>
					<span class="yonghu-yingshoufei-bcye"></span>
				</li>
				<li class="mui-table-view-cell">
					<span>本次应收：</span>
					<span class="yonghu-yingshoufei-totalje-ys"></span>
				</li>
				<li class="mui-table-view-cell">
					<label class="reading-lable">收到金额：</label>
					<input type="number" class="mui-input-clear cost-input" placeholder="请输入" autofocus="autofocus">
				</li>
				<li class="mui-table-view-cell">
					<span>本次余额：</span>
					<span class="yonghu-yingshoufei-this-balance"></span>
				</li>
			</ul>
			<button type="button" class="mui-btn mui-btn-blue mui-btn-block confirm-btn">确认收费</button>
		</div>
		<!--底部导航-->
		<footer class="mui-bar mui-bar-footer footer-nav">
			<a class="mui-pull-left fa fa-home go-home" id="go-home"></a>
			<a class="mui-pull-right fa fa-sign-out go-out" id="go-out"></a>
			<h1 class="mui-title" id="admin-name">使用者姓名</h1>
		</footer>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/printer.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/login.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/users_list.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/test.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			mui.plusReady(function() {
				var costingApi = "http://223.85.248.171:8012/ashx/WebYonghuManagement.asmx/GernarlPayMoney",
					chargeResults = {
						url: "/pages/fee_charge/charge_results.html",
						id: "charge_results"
					},
					userID = window.localStorage.getItem("userID"),
					zuticode = window.localStorage.getItem("zuticode"),
					number = 0,
					/* 收费列表 */
					costing = function(api, ickaBh, inputVal, yingShouFeiId, userID, zuticode, chargeResults) {
						$.ajax({
							url: api,
							type: "Post",
							data: {
								ickaBh: ickaBh,
								biaoHao: "",
								je: inputVal,
								yingShouFeiId: yingShouFeiId + ",",
								remark: "",
								userId: userID,
								zuticode: zuticode
							},
							timeout: 5000,
							beforeSend: function() {
								plus.nativeUI.showWaiting("等待中");
							},
							success: function success(data) {
								plus.nativeUI.closeWaiting();
								var data = JSON.parse(data.getElementsByTagName("string")[0].childNodes[0].nodeValue),
									data1 = data.ResultDataTwo,
									/* printData = [data1.rq, data1.UserName, data1.je, data1.bcje, data1.lateFee, data1.bcje + data1.je], */
									//测试打印
									PrintText = data.ResultData;
								window.localStorage.setItem("gouqiMXid", data1.gouqiId)
								/* 	window.localStorage.setItem("printData", printData) */
								bleObj.gotoPrint("\r\n\r\n" + PrintText + "\r\n\r\n\r\n");
								window.localStorage.setItem("PrintText1", data.ResultData)
								/* 	mui.toast(data.DataMessage)
									if (data.DataSuccess) {
										mui.openWindow(usersList)
									} */
								mui.openWindow(chargeResults)

							},
							error: function error(data) {
								//200的响应也有可能被认定为error，responseText中没有Message部分
								//mui.alert(JSON.parse(data.responseText).Message);
								mui.alert("获取数据失败，请返回上级页面")
								plus.nativeUI.closeWaiting();
							},
							complete: function complete(data) {
								//after success or error
							}
						});
					};
				var savedBleId = localStorage.getItem("bleId");
				if (savedBleId) {
					var bleObj = new ConnectPrinter(savedBleId);

				} else {
					plus.nativeUI.confirm('打印机未设置，是否前往设置？', function(e) {
						if (e.index === 0) {
							mui.openWindow({
								id: "/pages/printer.html",
								url: "/pages/printer.html"
							});
						} else {
							mui.toast("请先连接打印机!!")
						}
					});
				}
				$("#content").on("tap", ".confirm-btn", function() {
					/* 	number++
						if (number >= 1) {
							mui.alert("不能重复收费")
						} else {
							
						} */
					var ickaBh = $(".yonghu-info-number").text(),
						inputVal = Number($(".cost-input").val()),
						totalje = $(".yonghu-yingshoufei-totalje-ys").text(),
						bcye = Number($(".yonghu-yingshoufei-bcye").text()),
						yingShouFeiId = $(".yonghu-yingshoufei-length").eq(0).attr("yingshoufei-id");
					costing(costingApi, ickaBh, inputVal, yingShouFeiId, userID, zuticode, chargeResults)

					$(".yonghu-yingshoufei-this-balance").text((inputVal - totalje).toFixed(2))
				})
				$("#content").on("change", ".cost-input", function() {
					var inputVal = Number($(".cost-input").val()),
						totalje = $(".yonghu-yingshoufei-totalje-ys").text(),
						bcye = Number($(".yonghu-yingshoufei-bcye").text());
					$(".yonghu-yingshoufei-this-balance").text((inputVal - totalje).toFixed(2))

				})

			})
		</script>
	</body>

</html>
